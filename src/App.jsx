import React,{useEffect,useState} from 'react'; import { auth, provider, db } from './firebase'; import { signInWithPopup, signOut, onAuthStateChanged } from 'firebase/auth'; import { collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, deleteDoc } from 'firebase/firestore'; import MapView from './MapView.jsx'; import { geocodeAddress } from './geocode'; export default function App(){ const [user,setUser]=useState(null); const [prestadores,setPrestadores]=useState([]); const [form,setForm]=useState({nome:'',telefone:'',endereco:'',categoria:'Mecânico',observacoes:''}); const [mapOpen,setMapOpen]=useState(false); const [mapCenter,setMapCenter]=useState(null); useEffect(()=>{ const unsub=onAuthStateChanged(auth,u=>setUser(u)); return ()=>unsub(); },[]); useEffect(()=>{ const q=query(collection(db,'prestadores'), orderBy('nome')); const unsub=onSnapshot(q,snap=>setPrestadores(snap.docs.map(d=>({id:d.id,...d.data()})))); return ()=>unsub(); },[]); async function handleLogin(){ try{ await signInWithPopup(auth, provider); }catch(e){ alert('Login failed: '+e.message); }} function handleLogout(){ signOut(auth);} async function handleSubmit(e){ e&&e.preventDefault(); const address=form.endereco; let coords=null; if(address) coords=await geocodeAddress(address); const payload={nome:form.nome,telefone:form.telefone,endereco:form.endereco,categoria:form.categoria,observacoes:form.observacoes,coords}; try{ await addDoc(collection(db,'prestadores'), payload); setForm({nome:'',telefone:'',endereco:'',categoria:'Mecânico',observacoes:''}); }catch(err){ alert('Save error: '+err.message); } } function openMapAll(){ setMapCenter(null); setMapOpen(true);} function openMapFor(p){ if(p.coords) setMapCenter(p.coords); else alert('No coords'); setMapOpen(true);} return (!user? (<div style={{display:'flex',height:'100vh',alignItems:'center',justifyContent:'center'}}><div style={{textAlign:'center'}}><img src='/logo_full.png' style={{height:120}} alt='logo'/><h2>Condá Prestadores</h2><button onClick={handleLogin} style={{background:'#d50000',color:'#fff',padding:10}}>Sign in with Google</button></div></div>) : (<div style={{padding:20}}><header style={{display:'flex',justifyContent:'space-between'}}><div style={{display:'flex',alignItems:'center',gap:12}}><img src='/logo_full.png' style={{height:56}}/><div><h1 style={{margin:0}}>Condá Prestadores</h1><small style={{color:'#666'}}>Cadastro de Prestadores de Serviços</small></div></div><div><button onClick={openMapAll}>View map</button><button onClick={handleLogout}>Sign out</button></div></header><main style={{maxWidth:900,marginTop:20}}><form onSubmit={handleSubmit} style={{background:'#fff',padding:16,borderRadius:8}}><div style={{display:'grid',gridTemplateColumns:'2fr 1fr',gap:8}}><input className='input' placeholder='Name' value={form.nome} onChange={e=>setForm({...form,nome:e.target.value})}/><select className='input' value={form.categoria} onChange={e=>setForm({...form,categoria:e.target.value})}><option>Mecânico</option><option>Funilaria/Chapeador</option><option>Eletricista</option></select><input className='input' placeholder='Phone' value={form.telefone} onChange={e=>setForm({...form,telefone:e.target.value})}/><input className='input' placeholder='Address' value={form.endereco} onChange={e=>setForm({...form,endereco:e.target.value})}/><textarea className='input' placeholder='Notes' value={form.observacoes} onChange={e=>setForm({...form,observacoes:e.target.value})} style={{gridColumn:'1 / -1'}}></textarea><div style={{display:'flex',justifyContent:'flex-end',gridColumn:'1 / -1',gap:8}}><button className='btn-primary' type='submit'>Add provider</button></div></div></form><div style={{marginTop:20}}>{prestadores.length===0? (<div>No providers yet.</div>): (<div style={{display:'grid',gap:12,marginTop:12}}>{prestadores.map(p=>(<div key={p.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:12,background:'#fff',borderRadius:8}}><div><div style={{fontWeight:600}}>{p.nome}</div><div style={{color:'#666'}}>{p.categoria} • {p.telefone}</div><div style={{color:'#666'}}>{p.endereco}</div></div><div style={{display:'flex',flexDirection:'column',gap:6}}><div style={{display:'flex',gap:6}}><button onClick={()=>openMapFor(p)}>Map</button><button onClick={()=>{ window.open(`https://wa.me/${(p.telefone||'').replace(/[^0-9]/g,'')}`,'_blank') }}>WhatsApp</button></div><div style={{display:'flex',gap:6}}><button onClick={()=>{}}>Edit</button><button onClick={()=>{}}>Delete</button></div></div></div>))}</div>)}</div></main>{mapOpen && (<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:'center',justifyContent:'center'}}><div style={{width:'95%',maxWidth:1000,background:'#fff',borderRadius:8,overflow:'hidden'}}><div style={{padding:8,display:'flex',justifyContent:'space-between'}}><strong>Map — Providers</strong><button onClick={()=>setMapOpen(false)}>Close</button></div><MapView markers={prestadores} center={mapCenter} /></div></div>)} </div>)); }
